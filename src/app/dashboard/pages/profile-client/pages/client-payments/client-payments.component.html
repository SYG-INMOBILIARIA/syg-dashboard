<!-- Resumen superior -->
<div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
  <!-- Total Abonado -->
  <div class="bg-white rounded-lg shadow p-4 dark:bg-slate-800 dark:border-gray-400">
    <div class="flex items-center gap-2 mb-2">
      <div class="bg-green-50 p-2 rounded">
        <span class="iconify text-green-500" data-icon="ph:currency-circle-dollar"></span>
      </div>
      <span class="text-gray-600 font-medium dark:text-slate-300">Total Abonado</span>
    </div>
    <div class="text-2xl font-bold text-gray-900 dark:text-slate-200">
      S/ {{ totalPaid() | number:'.2-2' }}
    </div>
  </div>

  <!-- Deuda Restante -->
  <div class="bg-white rounded-lg shadow p-4 dark:bg-slate-800 dark:border-gray-400">
    <div class="flex items-center gap-2 mb-2">
      <div class="bg-red-50 p-2 rounded">
        <span class="iconify text-red-500" data-icon="ph:money"></span>
      </div>
      <span class="text-gray-600 font-medium dark:text-slate-300">Deuda Restante</span>
    </div>
    <div class="text-2xl font-bold text-gray-900 dark:text-slate-200">
      S/ {{ totalDebt() | number:'.2-2' }}
    </div>
  </div>

  <!-- Cuotas Pendientes -->
  <div class="bg-white rounded-lg shadow p-4 dark:bg-slate-800 dark:border-gray-400">
    <div class="flex items-center gap-2 mb-2">
      <div class="bg-amber-50 p-2 rounded">
        <span class="iconify text-amber-500" data-icon="ph:warning"></span>
      </div>
      <span class="text-gray-600 font-medium dark:text-slate-300">Cuotas Pendientes</span>
    </div>
    <div class="text-2xl font-bold text-gray-900 dark:text-slate-200">
       {{ countDebt() }}
    </div>
  </div>

  <!-- Cuotas Pagadas -->
  <div class="bg-white rounded-lg shadow p-4 dark:bg-slate-800 dark:border-gray-400">
    <div class="flex items-center gap-2 mb-2">
      <div class="bg-blue-50 p-2 rounded">
        <span class="iconify text-blue-500" data-icon="ph:check-circle"></span>
      </div>
      <span class="text-gray-600 font-medium dark:text-slate-300">Cuotas Pagadas</span>
    </div>
    <div class="text-2xl font-bold text-gray-900 dark:text-slate-200">
      {{ countPaid() }}
    </div>
  </div>
</div>

<div class="flex flex-wrap ">
  <div class="flex-none w-full max-w-full ">
    <div class="relative flex flex-col min-w-0 mb-6 break-words bg-white border-solid shadow-md dark:bg-slate-800 dark:shadow-dark-md rounded-2xl bg-clip-border ">

      <div class="flex flex-col gap-2 md:flex-row md:items-center justify-between py-6 px-4">
        <div>
          <h1 class="text-3xl font-bold text-gray-800 dark:text-slate-100">
            Cuotas pendientes
          </h1>


        </div>

        <div>
          <div class="w-[500px] flex justify-center items-center gap-3 ">
            <label for="cbxContract" class="block mb-2  font-medium text-gray-900 dark:text-white">
              Contrato:
            </label>
            <ng-select
              id="cbxContract"
              class="navbar bg-gray-50 border text-gray-900 text-sm rounded-lg block w-full dark:bg-gray-600  dark:placeholder-gray-400 dark:text-white dark:focus:ring-primary-500 dark:focus:border-primary-500"
              [items]="contracts()"
              [searchable]="false"
              bindLabel="code"
              bindValue="id"
              placeholder="Seleccione contrato"
              [formControl]="contractInput"
              [class.border-red-400]=" contractInputErrors && contractInputIsTouched"
              (change)="onChangeContractSelected($event)"
            >

              <ng-template ng-option-tmp let-item="item" class="text-gray-900 whitespace-nowrap dark:text-white text-left ">

                <div class=" flex justify-between">
                  <div class="text-normal flex justify-center items-center gap-1.5 ">
                    <span class="italic text-slate-500 c">
                      Código:
                    </span>
                    <span class="font-semibold text-md">
                      {{ item.code }}
                    </span>
                  </div>

                  <div class=" flex justify-end items-center gap-2.5">

                    <div class="italic text-slate-500 ">

                      Clientes:

                    </div>

                    <div >
                      @for (client of item.clients; track client.id; let i = $index) {
                        <div class="uppercase font-semibold">
                          {{ client.fullname }}
                        </div>
                        <div class="font-normal text-sm text-gray-500 pe-5">
                          {{ client.identityDocument?.shortDescription ?? '---' }} : {{ client.identityNumber ?? '---' }}
                        </div>
                      }
                    </div>

                  </div>
                </div>

              </ng-template>

            </ng-select>


          </div>
        </div>

        <div class="flex items-center gap-3">
          <button
            type="button"
            class="inline-block px-6 py-2 mr-3 font-semibold text-center text-white align-middle transition-all rounded cursor-pointer bg-emerald-600 hover:bg-emerald-700 leading-normal ease-in tracking-tight-rem shadow-xs bg-150 bg-x-25 hover:-translate-y-px active:opacity-85 hover:shadow-md"
            (click)="onSetContractQuoteToPay()"
            >
            <i class="fa-solid fa-plus mr-1"></i>
            Pagar múltiples cuotas
          </button>

          <button class="border border-gray-300 text-gray-700 inline-block px-4 py-2 mr-3 font-semibold text-center  align-middle transition-all rounded cursor-pointer leading-normal ease-in tracking-tight-rem shadow-xs bg-150 bg-x-25 hover:-translate-y-px active:opacity-75 hover:shadow-md dark:text-slate-200">
            <i class="fa-solid fa-download h-5 w-5 mr-1"></i>
            Descargar Reporte PDF
          </button>

          <button
            #btnShowPaymentQuoteInfoModal
            type="button"
            data-modal-target="payment-quote-detail-modal"
            data-modal-toggle="payment-quote-detail-modal"
            class="hidden px-6 py-2 mr-3 font-semibold text-center text-white align-middle transition-all rounded cursor-pointer bg-emerald-600 hover:bg-emerald-700 leading-normal ease-in tracking-tight-rem shadow-xs bg-150 bg-x-25 hover:-translate-y-px active:opacity-85 hover:shadow-md"
          >
            Mostrar pago
          </button>

          <button
            #btnShowPaymentModal
            type="button"
            data-modal-target="payment-modal"
            data-modal-toggle="payment-modal"
            class="hidden px-6 py-2 mr-3 font-semibold text-center text-white align-middle transition-all rounded cursor-pointer bg-emerald-600 hover:bg-emerald-700 leading-normal ease-in tracking-tight-rem shadow-xs bg-150 bg-x-25 hover:-translate-y-px active:opacity-85 hover:shadow-md"
          >
            Mostrar pago
          </button>
        </div>
      </div>

      <div class=" overflow-hidden">
        <table class="w-full text-sm text-left">
          <thead >
            <tr class="bg-gray-50/50">

              <th class="px-6 py-3 font-semibold text-gray-600 ">CUOTA</th>
              <th class="px-6 py-3 font-semibold text-gray-600 ">CONTRATO</th>
              <th class="px-6 py-3 font-semibold text-gray-600 ">CLIENTE</th>
              <th class="px-6 py-3 font-semibold text-gray-600 ">
                <div class="flex items-center">
                  FECHA DE PAGO
                  <svg xmlns="http://www.w3.org/2000/svg" class="ml-1 h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <polyline points="6 9 12 15 18 9"></polyline>
                  </svg>
                </div>
              </th>
              <th class="px-6 py-3 font-semibold text-gray-600 ">STATUS</th>
              <th class="px-6 py-3 font-semibold text-gray-600 w-32 ">MONTO</th>
              <th class="px-6 py-3 font-semibold text-gray-600 w-32 ">MORA</th>
              <th class="px-6 py-3 font-semibold text-gray-600 w-32 ">ABONADO</th>
              <th class="px-6 py-3 font-semibold text-gray-600 w-32 ">DEUDA</th>
              <th class="px-6 py-3 font-semibold text-gray-600  text-right">
                ACCIONES
              </th>
            </tr>
          </thead>
          <tbody>

            @if (isLoading()) {
              <tr>
                <td colspan="10">
                  <div class="flex justify-center items-center gap-2 h-14 p-2">
                    <spinner></spinner>
                    Cargando...
                  </div>
                </td>
              </tr>
            } @else {

              @for ( contractQuote of contractQuotes(); track $index) {

                <!-- Row 1 hover:bg-gray-50/50-->
                <tr class="border-b dark:border-white/40 border-gray-200 dark:text-slate-400 ">

                  <td class="font-medium p-4">
                    {{ contractQuote.code }}
                  </td>
                  <td class="font-medium ">
                    {{ contractQuote.contract.code }}
                  </td>
                  <td class="flex justify-start">

                    @for (client of contractQuote.contract.clients; track client.id) {
                      <div class="">
                        {{ client.fullname }}
                      </div>
                    }

                  </td>
                  <td class="">
                    {{ contractQuote.paymentDate | moment:'createAt' }}
                  </td>
                  <td class="">
                    <span
                      class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium "
                      [ngClass]="{
                        'bg-[#F2FCE2] text-[#16a34a]': contractQuote.isPaid,
                        'bg-[#FFDEE2] text-[#ea384c]': !contractQuote.isPaid
                        }"
                    >
                      @if (contractQuote.isPaid) {
                        Pagado
                      } @else {
                        No pagado
                      }
                    </span>
                  </td>
                  <td class="  font-semibold">
                    S/ {{ contractQuote.amountToPay | number: '.2-2' }}
                  </td>
                  <td class="  font-semibold">
                    S/ {{ contractQuote.tardinessAmount | number: '.2-2' }}
                  </td>
                  <td class="  font-semibold">
                    S/ {{ contractQuote.totalPaid| number: '.2-2' }}
                  </td>
                  <td class="  font-semibold">
                    S/ {{ contractQuote.totalDebt| number: '.2-2' }}
                  </td>
                  <td class="  ">

                    @if ( !contractQuote.isPaid ) {

                      <div class=" flex justify-center items-center gap-3">

                        @if ( !contractQuote.isExoneratedTardiness ) {
                          <button
                            type="button"
                            class="bg-gray-100 text-gray-600 hover:bg-gray-200 border border-gray-200 px-3 py-1 rounded-md"
                            (click)="onExonerateTardinessConfirm( contractQuote )"
                            >
                            Exo. Mora
                          </button>
                        }

                        <button
                          type="button"
                          class=" bg-emerald-600 hover:bg-emerald-700 text-white px-3 py-1 rounded-md"
                          (click)="onSetContractQuoteToPay( contractQuote )"
                          >
                          Pagar
                        </button>
                      </div>

                    } @else {
                      <button
                        type="button"
                        class=" bg-emerald-600 hover:bg-emerald-700 text-white px-3 py-1 rounded-md"
                        (click)="onGetPaymentQuoteInfo( contractQuote.id)"
                      >
                        Ver
                      </button>
                    }


                  </td>
                </tr>

              } @empty {

                @if (!isLoading()) {
                  <tr>
                    <td colspan="10">
                      <div class="text-center p-4 border-b text-xl text-slate-400">
                        Sin registros
                      </div>
                    </td>
                  </tr>
                }
              }
            }

          </tbody>
        </table>

        <div class="" >

          <!-- (onChangePage)="" -->
          <app-pagination [totalItems]="contractQuotesTotal()" (onChangePage)="onGetContractQuotesPagination( $event )"  >
          </app-pagination>

        </div>
      </div>

    </div>
  </div>
</div>



<paid-quotes-modal
  [contractQuotesData]="contractQuotesAll()"
  [contractQuotesToPaid]="contractQuoteToPay()"
  [webUrlPermissionMethods]="webUrlPermissionMethods()"
  (paidQuoteSuccess)="onGetContractQuotes()" >
</paid-quotes-modal>


<!-- Main modal -->
<div id="payment-quote-detail-modal" data-modal-backdrop="true" tabindex="-1" aria-hidden="false" class="hidden overflow-y-auto overflow-x-hidden fixed top-0 mt-5 right-0 left-0 z-50 justify-center items-center w-full md:inset-0 h-[calc(100%-1rem)] max-h-full">
  <div class="relative p-4 w-full max-w-lg max-h-full">

      <!-- Modal content -->
      <div class="relative bg-white rounded-lg shadow dark:bg-gray-700">
          <!-- Modal header -->
          <div class="flex items-center justify-between p-4 md:p-5 border-b rounded-t dark:border-gray-600">
              <h3 class="text-lg font-semibold text-gray-900 dark:text-white" >
                  Pago de cuota
              </h3>
              <button
                #btnClosePaymentQuoteInfoModal
                type="button"
                data-modal-toggle="payment-quote-detail-modal"
                class="text-gray-400 bg-transparent hover:bg-gray-200 hover:text-gray-900 rounded-lg text-sm w-8 h-8 ms-auto inline-flex justify-center items-center dark:hover:bg-gray-600 dark:hover:text-white"
              >
                  <svg class="w-3 h-3" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 14 14">
                      <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="m1 1 6 6m0 0 6 6M7 7l6-6M7 7l-6 6"/>
                  </svg>
                  <span class="sr-only">Close modal</span>
              </button>
          </div>
          <!-- Modal body -->

          <div class="p-4">
            <span class="font-semibold text-gray-800 dark:text-gray-200">
              Detalles del pago de la cuota
            </span>


            <div class="grid gap-3 mb-1 grid-cols-12  ">

              <div class="col-span-12" *ngFor="let payment of paymentsByCuote()" >


                <div class="mt-4">

                  <div class="flex gap-2 justify-start">
                    <span class="italic w-32">Fecha de pago: </span>
                    <span>
                      {{ payment.paymentDate }}
                    </span>
                  </div>

                  <div class="flex gap-2 justify-start">
                    <span class="italic w-32">Cuotas: </span>
                    <div *ngFor="let quote of payment.quotes" class="p-2 border border-gray-200 " >
                      <div>
                         Código: {{ quote.code }}
                      </div>
                      <div>
                        Monto: S/ {{ quote.totalPaid| number:'.2-2' }}
                      </div>
                    </div>
                  </div>

                  <div class="flex gap-2 justify-start" *ngIf="payment.photo" >
                    <span class="italic w-32">Descargar comprobante: </span>
                    <div class="flex justify-center items-center">
                      <a
                        class="text-blue-600 underline"
                        [href]=" payment.photo.urlImg "
                        target="_blank"
                        download
                      >
                      <i class="fa-solid fa-download"></i>
                      </a>
                  </div>

                </div>

              </div>

            </div>

          </div>

      </div>
  </div>
</div>
